<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Jur√≠dico | LexOpsInsight</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="assets/css/app.css">

    <script id="consolidated-data" type="application/json"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        brand: { 500: 'var(--brand-500)', 600: 'var(--brand-600)' }
                    }
                }
            }
        }
    </script>

        <style>
        /* === VARI√ÅVEIS VISUAIS === */
        :root { 
            --brand-500: #4f46e5; 
            --brand-600: #4338ca; 
            --primary-accent: #4f46e5;
            
            /* Vari√°veis de Layout */
            --layout-bg: #e2e8f0; 
            --layout-card: #ffffff; 
            --layout-text: #111827;
            --layout-border: #E5E7EB; 
            --layout-accent: #F3F4F6;
            --layout-sidebar: #0f172a; 
            --layout-sidebar-text: #f8fafc; 
            --layout-sidebar-border: #1e293b;

            /* Vari√°veis do Cabe√ßalho (White Label) - CORRE√á√ÉO APLICADA AQUI */
            --header-bg-rgb: 255, 255, 255; /* Padr√£o Branco */
            --header-opacity: 1;            /* Padr√£o S√≥lido */
            --header-text: #111827;         /* Padr√£o Escuro */
        }
        
        /* === BASE === */
        html { height: 100%; }
        body { 
            background: var(--layout-bg); color: var(--layout-text); 
            overflow: hidden; height: 100vh;
            font-family: 'Inter', sans-serif;
        }

        /* =========================================
           CORRE√á√ÉO 1: LOGO LEXOPS (OCUPANDO O CANTO)
           ========================================= */
        .lexops-logo-admin {
            display: flex; 
            align-items: center; 
            justify-content: center;
            height: 160px; 
            width: 100%;
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            margin-bottom: 1rem;
            padding: 15px; 
            background: rgba(0,0,0,0.2) !important;
        }
        
        .lexops-logo-admin img {
            width: 100% !important; 
            height: 100% !important; 
            max-width: none !important; 
            object-fit: contain; 
            pointer-events: none;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
        }

        /* =========================================
           CORRE√á√ÉO 2: CAMPOS DA BARRA LATERAL (LEITURA)
           ========================================= */
        /* For√ßa fundo escuro e texto branco nos inputs da esquerda */
        #adminPanel select, 
        #adminPanel input[type="text"], 
        #adminPanel input[type="number"], 
        #adminPanel input[type="color"],
        #adminPanel textarea {
            background-color: #1e293b !important; /* Fundo Escuro S√≥lido */
            color: #ffffff !important; /* Texto Branco */
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        /* Op√ß√µes do Dropdown (Fundo Branco, Texto Preto) */
        #adminPanel select option {
            background-color: #ffffff !important;
            color: #1e293b !important;
        }

        /* Placeholder mais claro para ler */
        #adminPanel input::placeholder {
            color: rgba(255, 255, 255, 0.5) !important;
        }

        /* =========================================
           LOGOS CLIENTE/ESCRIT√ìRIO (PROTEGIDAS)
           ========================================= */
        .logo-resizable-wrapper {
            display: inline-flex; resize: both; overflow: hidden; vertical-align: middle; position: relative;
            border: 1px dashed rgba(0,0,0,0.1); 
            width: 140px; height: 70px; 
            min-width: 50px; max-width: 600px; min-height: 30px; max-height: 300px;
        }
        .logo-resizable-wrapper:hover { border-color: rgba(0,0,0,0.4); cursor: nwse-resize; background: rgba(0,0,0,0.02); }
        .logo-resizable-wrapper:hover::after {
            content: ''; position: absolute; bottom: 0; right: 0; width: 12px; height: 12px;
            background: linear-gradient(135deg, transparent 50%, #94a3b8 50%); pointer-events: none;
        }
        .logo-resizable-wrapper img {
            width: 100% !important; height: 100% !important;
            object-fit: contain; pointer-events: none;
        }
        #clientLogo, #officeLogo { display: none; }

        /* =========================================
           FILTROS LEG√çVEIS (TEXTO ESCURO)
           ========================================= */
        #clientControls, #clientControls * {
            color: #0f172a !important; 
            border-color: #cbd5e1;
        }
        #clientControls button:hover { background-color: #f1f5f9 !important; }
        #globalSearch { background: #ffffff !important; color: #0f172a !important; border: 1px solid #cbd5e1 !important; }
        .filter-dropdown { background: #ffffff !important; border-color: #e2e8f0 !important; }
        .filter-dropdown label { color: #334155 !important; }

        /* ========================================= */

        /* === RESTO DO LAYOUT === */
        #protectedContent { display: none; width: 100%; height: 100%; flex: 1; overflow: hidden; }
        .glass-dark { background: var(--layout-sidebar); color: var(--layout-sidebar-text); }
        .admin-panel { display: flex; flex-direction: column; }
        
        /* CORRE√á√ÉO APLICADA AQUI: HEADER DIN√ÇMICO */
        .brand-header {
            height: 9rem; 
            /* Agora usa as vari√°veis controladas pelo painel admin */
            background: rgba(var(--header-bg-rgb), var(--header-opacity)); 
            color: var(--header-text);
            border-bottom: 1px solid #e0e0e0;
            display: flex; align-items: center; padding: 0 1.5rem; justify-content: space-between;
            transition: background 0.3s, color 0.3s; /* Suaviza a troca de cor */
        }
        
        .header-section { flex: 1; display: flex; align-items: center; height: 100%; }
        .header-left { justify-content: flex-end; padding-right: 1rem; }
        .header-right { justify-content: flex-start; padding-left: 1rem; }
        .header-center { 
            flex: 0 0 380px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-left: 1px solid #E5E7EB; border-right: 1px solid #E5E7EB; height: 70%;
            /* Herda a cor do texto do header pai */
            color: inherit; 
        }
        .header-center h1 { 
            font-size: 1.5rem; font-weight: 900; text-transform: uppercase; 
            line-height: 1; margin: 0; 
            color: inherit; /* Herda a cor personalizada */
        }
        .header-center p { 
            font-size: 0.65rem; font-style: italic; 
            margin-top: 0.3rem;
            opacity: 0.7; /* Herda a cor mas um pouco mais claro */
            color: inherit;
        }
        
        .logo-placeholder { 
            border: 1px solid #e0e0e0; border-radius: 4px; padding: 0.8rem 1.5rem; 
            color: #999; font-size: 0.65rem; font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .logo-placeholder:hover { background: #f9f9f9; color: #666; }

        .hidden { display: none !important; }
        #pageLoader { position: fixed; inset: 0; background: #e2e8f0; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #cbd5e1; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        body.client-mode .admin-panel, body.client-mode .logo-placeholder { display: none !important; }
        body.client-mode .client-controls { display: flex !important; }

        #accessError { display: none; height: 100vh; align-items: center; justify-content: center; }
        #accessError.active { display: flex; }
        .err-box { background: #fff; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(203, 213, 225, 0.5); border-radius: 3px; }
    </style>
<script id="auth-logic">
(function() {
    // 1. Fun√ß√£o de Desbloqueio Visual (S√≥ roda quando a tela existe)
    function unlockUI() {
        const app = document.getElementById('protectedContent');
        const loader = document.getElementById('pageLoader');
        const err = document.getElementById('accessError');

        // Remove Loader
        if (loader) loader.style.display = 'none';

        // Mostra o App (Garante display flex e remove hidden se existir)
        if (app) {
            app.classList.remove('hidden'); 
            app.style.display = 'flex';
        }

        // Esconde erro
        if (err) {
            err.classList.remove('active');
            err.style.display = 'none';
        }
    }

    // 2. L√≥gica de Decis√£o (Quem entra e quem n√£o entra)
    function checkPermission() {
        // A. Cliente Offline (Arquivo Exportado)
        if (window.__OFFLINE_PAYLOAD__) {
            window.__ACCESS_GRANTED__ = true;
            window.isAdmin = false;
            document.documentElement.classList.add('client-view');
            unlockUI(); // <--- Libera visual
            return;
        }

        // B. Admin Online (Link com Token)
        const params = new URLSearchParams(window.location.search);
       const token = params.get('t') || params.get('token') || localStorage.getItem('lexops_token');
        const API_ENDPOINT = "/.netlify/functions/validateToken";

        if (token && token.length > 5) {
            // Sucesso Preliminar
            window.__ACCESS_GRANTED__ = true;
            window.isAdmin = true;
            localStorage.setItem('lexops_token', token);
            unlockUI(); // <--- Libera visual IMEDIATAMENTE

            // Valida√ß√£o de Fundo (Sem travar tela)
            fetch(`${API_ENDPOINT}?token=${token}`)
                .then(r => r.json())
                .then(d => { if(!d.valid) bloquear(); })
                .catch(e => console.log("API Check Skipped"));
        } else {
            bloquear();
        }
    }

    function bloquear() {
        window.__ACCESS_GRANTED__ = false;
        const app = document.getElementById('protectedContent');
        const err = document.getElementById('accessError');
        const loader = document.getElementById('pageLoader');
        
        if(app) app.style.display = 'none';
        if(loader) loader.style.display = 'none';
        if(err) { err.style.display = 'flex'; err.classList.add('active'); }
    }

    // 3. O SEGREDO: S√≥ executa quando o navegador terminar de montar o HTML
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', checkPermission);
    } else {
        // Se j√° carregou, roda direto
        checkPermission();
    }
})();
</script>
    </head>
<body class="font-sans text-sm">

    <div id="accessError">
        <div class="message">Acesso Negado</div>
    </div>

    <div id="protectedContent" class="flex h-screen">

    <aside id="adminPanel" class="admin-panel w-80 glass-dark flex flex-col shrink-0 transition-all" style="z-index: 1000; position: relative;">
        <div class="lexops-logo-admin">
    <img src="assets/img/logo-lexops.png" alt="LexOps Insight" id="lexopsLogoImg">
</div>

        <div class="flex-1 overflow-y-auto p-5 pt-2 space-y-8" style="position: relative; z-index: 1001;">
            <section class="space-y-4">
                <h3 class="text-[10px] font-bold uppercase tracking-widest border-b pb-2 admin-section-title" style="border-color: var(--layout-sidebar-border)"><i class="fas fa-database mr-2"></i> Configura√ß√£o</h3>
                <div class="space-y-2">
                    <button onclick="document.getElementById('fileInput').click()" class="w-full py-3 rounded-lg text-xs font-bold border flex items-center justify-center gap-2 transition-all group shadow-md admin-button" style="position: relative; z-index: 1002; cursor: pointer;">
                        <i class="fas fa-file-excel text-emerald-400 text-sm group-hover:scale-110"></i> Importar Base
                    </button>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" class="hidden">
                </div>
                <div class="grid grid-cols-2 gap-2 pt-1">
                    <button onclick="document.getElementById('logoClient').click()" class="admin-button text-[10px] py-2.5 rounded border transition-all font-medium"><i class="fas fa-building mr-1"></i> Logo Cliente</button>
                    <button onclick="document.getElementById('logoOffice').click()" class="admin-button text-[10px] py-2.5 rounded border transition-all font-medium"><i class="fas fa-briefcase mr-1"></i> Logo Escrit√≥rio</button>
                </div>
                <input type="file" id="logoOffice" accept="image/*" class="hidden">
                <input type="file" id="logoClient" accept="image/*" class="hidden">
            </section>

            <details class="support-materials-section no-export hide-on-print d-print-none" open>
                <summary class="text-[10px] font-bold uppercase tracking-widest border-b pb-2 admin-section-title cursor-pointer" style="border-color: var(--layout-sidebar-border); list-style: none; padding-bottom: 0.5rem; margin-bottom: 0.5rem;">
                    <i class="fas fa-folder-open mr-2"></i> üìÇ Materiais de Apoio e Downloads
                </summary>
                <section class="space-y-4">
                
                <div class="space-y-3">
                    <div class="p-3 rounded-lg border admin-button" style="border-color: rgba(255,255,255,0.1)">
                        <h4 class="text-[9px] font-bold uppercase tracking-wide mb-2 admin-section-title"><i class="fas fa-chart-bar mr-1.5"></i> üìä Modelos de Planilhas</h4>
                        <div class="space-y-1.5">
                            <a href="assets/docs/planilha-base-geral.xlsx" download class="block w-full py-2 px-3 rounded text-xs font-medium text-center transition-all border" style="border-color: rgba(255,255,255,0.2); color: rgba(255,255,255,0.8); hover:background-color: rgba(255,255,255,0.1);">
                                <i class="fas fa-download mr-1"></i> Base Geral
                            </a>
                            <a href="assets/docs/planilha-executiva.xlsx" download class="block w-full py-2 px-3 rounded text-xs font-medium text-center transition-all border" style="border-color: rgba(255,255,255,0.2); color: rgba(255,255,255,0.8); hover:background-color: rgba(255,255,255,0.1);">
                                <i class="fas fa-download mr-1"></i> Executiva
                            </a>
                            <a href="assets/docs/planilha-multicliente.xlsx" download class="block w-full py-2 px-3 rounded text-xs font-medium text-center transition-all border" style="border-color: rgba(255,255,255,0.2); color: rgba(255,255,255,0.8); hover:background-color: rgba(255,255,255,0.1);">
                                <i class="fas fa-download mr-1"></i> Multicliente
                            </a>
                            <a href="assets/docs/planilha-trabalhista.xlsx" download class="block w-full py-2 px-3 rounded text-xs font-medium text-center transition-all border" style="border-color: rgba(255,255,255,0.2); color: rgba(255,255,255,0.8); hover:background-color: rgba(255,255,255,0.1);">
                                <i class="fas fa-download mr-1"></i> Trabalhista
                            </a>
                        </div>
                    </div>

                    <div class="p-3 rounded-lg border admin-button" style="border-color: rgba(255,255,255,0.1)">
                        <h4 class="text-[9px] font-bold uppercase tracking-wide mb-2 admin-section-title"><i class="fas fa-book mr-1.5"></i> üìò Documenta√ß√£o</h4>
                        <div class="space-y-1.5">
                            <a href="assets/docs/manual-usuario.pdf" download class="block w-full py-2 px-3 rounded text-xs font-medium text-center transition-all border" style="border-color: rgba(255,255,255,0.2); color: rgba(255,255,255,0.8); hover:background-color: rgba(255,255,255,0.1);">
                                <i class="fas fa-download mr-1"></i> Manual do Usu√°rio
                            </a>
                            <a href="assets/docs/termo-uso.pdf" download class="block w-full py-2 px-3 rounded text-xs font-medium text-center transition-all border" style="border-color: rgba(255,255,255,0.2); color: rgba(255,255,255,0.8); hover:background-color: rgba(255,255,255,0.1);">
                                <i class="fas fa-download mr-1"></i> Termo de Uso
                            </a>
                            <a href="assets/docs/termo-aceite.pdf" download class="block w-full py-2 px-3 rounded text-xs font-medium text-center transition-all border" style="border-color: rgba(255,255,255,0.2); color: rgba(255,255,255,0.8); hover:background-color: rgba(255,255,255,0.1);">
                                <i class="fas fa-download mr-1"></i> Termo de Aceite
                            </a>
                        </div>
                    </div>
                </div>
            </section>
            </details>

            <section class="space-y-4">
                <h3 class="text-[10px] font-bold uppercase tracking-widest border-b pb-2 admin-section-title" style="border-color: var(--layout-sidebar-border)"><i class="fas fa-paint-brush mr-2"></i> Apar√™ncia</h3>
                
                <div class="p-3 rounded-lg space-y-3 border admin-button" style="border-color: rgba(255,255,255,0.1)">
                    <div class="space-y-1">
                        <label class="text-[10px] block font-medium admin-section-title">Paleta de Gr√°ficos</label>
                        <select id="paletteSelect" onchange="updatePalette(this.value)" class="w-full border text-xs rounded p-2 outline-none admin-select">
                            <option value="indigo">LexOps Classic (Indigo)</option>
                            <option value="ocean">Oceanic Blue (Teal)</option>
                            <option value="sunset">Executive Sunset (Orange)</option>
                            <option value="forest">Corporate Forest (Green)</option>
                            <option value="night">Night Vision (Purple)</option>
                            <option value="rose">High Alert (Red)</option>
                            <option value="gold">Golden Premium (Gold)</option>
                            <option value="slate">Corporate Slate (Gray)</option>
                            <option value="emerald">Professional Emerald (Green)</option>
                            <option value="crimson">Power Crimson (Red/Pink)</option>
                        </select>
                    </div>
                    <div class="flex justify-between items-center pt-1">
                        <span class="text-[10px] font-medium admin-section-title">Cor Personalizada</span>
                        <div class="h-6 w-6 rounded-full border overflow-hidden relative cursor-pointer hover:border-white" style="border-color: rgba(255,255,255,0.3)">
                            <input type="color" onchange="updateCustomColor(this.value)" class="absolute -top-2 -left-2 w-10 h-10 cursor-pointer">
                        </div>
                    </div>
                </div>

                <div class="p-3 rounded-lg space-y-3 border admin-button" style="border-color: rgba(255,255,255,0.1)">
                    <div class="space-y-1">
                        <label class="text-[10px] block font-medium admin-section-title">Tema do Layout</label>
                        <select id="layoutThemeSelect" onchange="updateLayoutTheme(this.value)" class="w-full border text-xs rounded p-2 outline-none admin-select">
                            <option value="minimal">Minimal White</option>
                            <option value="slate">Professional Slate</option>
                            <option value="midnight">Midnight Dark</option>
                            <option value="cream">Warm Cream</option>
                            <option value="ocean">Ocean Blue</option>
                            <option value="forest">Forest Green</option>
                            <option value="lavender">Soft Lavender</option>
                            <option value="ink">Corporate Ink</option>
                        </select>
                    </div>
                </div>

                <div class="p-3 rounded-lg space-y-3 border admin-button no-export hide-on-print d-print-none" style="border-color: rgba(255,255,255,0.1)">
                    <h4 class="text-[9px] font-bold uppercase tracking-wide mb-2 admin-section-title"><i class="fas fa-crown mr-1.5"></i> Identidade da Marca (White Label)</h4>
                    <div class="space-y-2">
                        <div class="space-y-1">
                            <label class="text-[10px] block font-medium admin-section-title">Cor de Destaque</label>
                            <div class="flex gap-2 items-center">
                                <input type="color" id="accentColorInput" value="#4f46e5" class="h-8 w-12 rounded cursor-pointer border border-slate-300">
                                <span class="text-[9px] opacity-60 admin-section-title flex-1">Usado em bot√µes e destaques</span>
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] block font-medium admin-section-title">T√≠tulo do Painel</label>
                            <input type="text" id="panelTitleInput" value="An√°lise Jur√≠dica Corporativa" class="w-full border text-xs rounded p-2 outline-none admin-select" placeholder="Ex: Painel do Cliente X">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] block font-medium admin-section-title">Texto do Rodap√©</label>
                            <input type="text" id="footerTextInput" value="" class="w-full border text-xs rounded p-2 outline-none admin-select" placeholder="Texto personalizado opcional">
                        </div>
                    </div>
                </div>

                <div class="p-3 rounded-lg space-y-3 border admin-button no-export hide-on-print d-print-none" style="border-color: rgba(255,255,255,0.1)">
                    <h4 class="text-[9px] font-bold uppercase tracking-wide mb-2 admin-section-title"><i class="fas fa-heading mr-1.5"></i> Estilo do Cabe√ßalho</h4>
                    <div class="space-y-2">
                        <div class="space-y-1">
                            <label class="text-[10px] block font-medium admin-section-title">Fundo do Cabe√ßalho</label>
                            <input type="color" id="headerBgInput" value="#ffffff" class="w-full h-8 rounded cursor-pointer border border-slate-300">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] block font-medium admin-section-title">Cor do Texto</label>
                            <input type="color" id="headerTextInput" value="#111827" class="w-full h-8 rounded cursor-pointer border border-slate-300">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] block font-medium admin-section-title">Opacidade do Fundo</label>
                            <div class="flex gap-2 items-center">
                                <input type="range" id="headerOpacityInput" min="0" max="1" step="0.1" value="1" class="flex-1 cursor-pointer">
                                <span class="text-[9px] opacity-60 admin-section-title w-8 text-right" id="opacityValue">100%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button onclick="resetLayout()" class="w-full py-2 rounded-lg text-xs font-bold border transition-all admin-button">
                    <i class="fas fa-undo mr-2"></i> Restaurar Padr√£o
                </button>
            </section>

            <section class="space-y-4">
                <h3 class="text-[10px] font-bold uppercase tracking-widest border-b pb-2 admin-section-title" style="border-color: var(--layout-sidebar-border)"><i class="fas fa-chart-line mr-2"></i> Criar Gr√°fico Personalizado</h3>
                <div class="p-3 rounded-lg space-y-3 border admin-button" style="border-color: rgba(255,255,255,0.1)">
                    <div class="space-y-1">
                        <label class="text-[10px] block font-medium admin-section-title">Eixo X (Dimens√£o)</label>
                        <select id="biX" class="w-full border text-xs rounded p-2 outline-none admin-select"></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] block font-medium admin-section-title">Eixo Y (M√©trica)</label>
                        <select id="biY" onchange="toggleYCol()" class="w-full border text-xs rounded p-2 outline-none admin-select">
                            <option value="count">Contagem (Quantidade de Processos)</option>
                            <option value="sum">Soma (Valor Total)</option>
                            <option value="avg">M√©dia (Valor M√©dio)</option>
                        </select>
                    </div>
                    <div id="biYColDiv" class="space-y-1 hidden">
                        <label class="text-[10px] block font-medium admin-section-title">Coluna de Dados (Eixo Y)</label>
                        <select id="biYCol" class="w-full border text-xs rounded p-2 outline-none admin-select">
                            <option value="">Selecione a coluna...</option>
                        </select>
                        <p class="text-[9px] opacity-60 mt-1 admin-section-title">üí° Todas as colunas da planilha dispon√≠veis</p>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] block font-medium admin-section-title">Tipo de Gr√°fico</label>
                        <select id="biType" class="w-full border text-xs rounded p-2 outline-none admin-select">
                            <option value="bar">Barras Vertical</option>
                            <option value="bar_h">Barras Horizontal</option>
                            <option value="line">Linha</option>
                            <option value="doughnut">Rosca (Doughnut)</option>
                            <option value="pie">Pizza (Pie)</option>
                            <option value="polarArea">√Årea Polar</option>
                            <option value="radar">Radar</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] block font-medium admin-section-title">T√≠tulo do Gr√°fico</label>
                        <input type="text" id="biTitle" placeholder="Ex: An√°lise de Valores por √Årea" class="w-full border text-xs rounded p-2 outline-none admin-select">
                    </div>
                    <button onclick="addChart()" class="w-full py-2.5 rounded-lg text-xs font-bold flex items-center justify-center gap-2 shadow-lg transition-all" style="background: var(--brand-500); color: white;">
                        <i class="fas fa-plus-circle"></i> Adicionar Gr√°fico
                    </button>
                </div>
            </section>

            <section class="space-y-4">
                <h3 class="text-[10px] font-bold uppercase tracking-widest border-b pb-2 admin-section-title" style="border-color: var(--layout-sidebar-border)"><i class="fas fa-filter mr-2"></i> Filtros de Dados</h3>
                <div id="filtersContainer" class="space-y-4 max-h-60 overflow-y-auto pr-1"></div>
            </section>
        </div>

        <div class="p-4 border-t space-y-2" style="background: var(--layout-sidebar); border-color: var(--layout-sidebar-border)">
            <button onclick="window.print()" class="w-full py-2.5 rounded-lg text-xs font-bold flex items-center justify-center gap-2 shadow-md admin-button">
                <i class="fas fa-print"></i> PDF
            </button>
            <button onclick="exportConsolidatedHTML()" class="w-full py-2.5 rounded-lg text-xs font-bold flex items-center justify-center gap-2 shadow-lg transition-all" style="background: #10b981; color: white;">
                <i class="fas fa-share-alt"></i> Exportar HTML
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full relative">
        <header class="brand-header shrink-0 shadow-sm">
           <div class="header-section header-left">
                <div id="wrapOffice" class="logo-resizable-wrapper hidden">
                    <img id="imgOffice" src="" alt="Logo Escrit√≥rio">
                </div>
                <div id="phOffice" class="logo-placeholder" onclick="document.getElementById('logoOffice').click()">Logo Escrit√≥rio</div>
            </div>

            <div class="header-center">
                <div id="lexopsHeaderFallback" style="display: block;">
                    <h1>An√°lise Jur√≠dica Corporativa</h1>
                </div>
                <p style="font-size: 0.65rem; margin-top: 0.3rem;">powered by <span class="font-bold not-italic">LexOpsInsight</span></p>
            </div>

            <div class="header-section header-right">
                <div id="wrapClient" class="logo-resizable-wrapper hidden">
                    <img id="imgClient" src="" alt="Logo Cliente">
                </div>
                <div id="phClient" class="logo-placeholder" onclick="document.getElementById('logoClient').click()">Logo Cliente</div>
            </div>
        </header>

        <div id="clientControls" class="client-controls hidden px-8 py-3 border-b items-center gap-4 z-30 shadow-sm no-print" style="background: var(--layout-card); border-color: var(--layout-border)">
            <div class="relative shrink-0">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                <input type="text" id="globalSearch" placeholder="Pesquisar em tudo..." class="pl-9 pr-4 py-2.5 rounded-lg text-xs w-64 focus:ring-2 focus:ring-brand-500 outline-none transition-all font-medium placeholder:text-slate-400" style="background: var(--layout-accent); border: 1px solid var(--layout-border); color: var(--layout-text)" onkeyup="renderAll()">
            </div>
            <div class="h-6 w-px mx-2" style="background: var(--layout-border)"></div>
            <div id="clientFilters" class="flex gap-2 flex-wrap flex-1 items-center pb-1"></div>
            <button onclick="resetFilters()" class="text-xs text-rose-500 hover:text-rose-700 font-bold hover:underline whitespace-nowrap ml-2">
                <i class="fas fa-undo mr-1"></i> Limpar Filtros
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-8" id="dashboardBody" style="background: var(--layout-bg)">
            <div id="abcAlert" class="hidden mb-6 p-5 rounded-xl border-l-4 shadow-md relative" style="background: linear-gradient(to right, rgba(251, 191, 36, 0.1), rgba(251, 191, 36, 0.02)); border-color: #f59e0b;">
                <button onclick="document.getElementById('abcAlert').classList.add('hidden')" class="absolute top-3 right-3 text-amber-600 hover:text-amber-800 transition-colors" title="Fechar">
                    <i class="fas fa-times text-lg"></i>
                </button>
                <div class="flex items-start gap-4">
                    <div class="text-3xl">‚ö†Ô∏è</div>
                    <div class="flex-1">
                        <h3 class="font-black text-sm mb-2" contenteditable="true" style="color: #92400e; outline: none; cursor: text;" title="Clique para editar">An√°lise de Concentra√ß√£o de Impacto</h3>
                        <div id="abcMessage" class="text-xs" contenteditable="true" style="color: #78350f; outline: none; cursor: text;" title="Clique para editar"></div>
                    </div>
                </div>
            </div>
            <div id="emptyState" class="h-full flex flex-col items-center justify-center opacity-50">
                <div class="w-24 h-24 bg-slate-200 rounded-full flex items-center justify-center mb-6">
                    <i class="fas fa-file-contract text-4xl text-slate-400"></i>
                </div>
                <h3 class="text-2xl font-bold text-slate-600">Dashboard Pronto</h3>
                <p class="text-slate-400 mt-2 text-sm">Carregue sua base de processos para come√ßar.</p>
            </div>

            <div id="dashContent" class="hidden space-y-8 pb-10">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 break-inside-avoid">
                    <div class="glass p-6 rounded-2xl border-t-4 border-slate-400 card relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 text-slate-100 group-hover:text-slate-200 transition-colors"><i class="fas fa-folder text-6xl opacity-20 transform rotate-12"></i></div>
                        <p class="text-[10px] font-bold uppercase tracking-wider mb-1 relative z-10" style="color: #6B7280">Volume Total</p>
                        <h3 class="text-4xl font-black relative z-10" style="color: var(--layout-text)" id="kTotal">0</h3>
                    </div>
                    <div class="glass p-6 rounded-2xl border-t-4 card relative overflow-hidden group" style="border-color: var(--brand-500)">
                        <div class="absolute right-0 top-0 p-4 text-slate-100 group-hover:text-slate-200 transition-colors"><i class="fas fa-coins text-6xl opacity-20 transform rotate-12"></i></div>
                        <p class="text-[10px] font-bold uppercase tracking-wider mb-1 relative z-10" style="color: #6B7280">Exposi√ß√£o Total</p>
                        <h3 class="text-4xl font-black text-brand-600 relative z-10" style="color: var(--brand-600)" id="kTotalVal">R$ 0</h3>
                    </div>
                    <div class="glass p-6 rounded-2xl border-t-4 border-rose-500 card relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 text-rose-100 group-hover:text-rose-200 transition-colors"><i class="fas fa-fire text-6xl opacity-20 transform rotate-12"></i></div>
                        <p class="text-[10px] font-bold text-rose-500 uppercase tracking-wider mb-1 relative z-10">Risco Prov√°vel</p>
                        <h3 class="text-4xl font-black relative z-10" style="color: var(--layout-text)" id="kRiskProv">R$ 0</h3>
                    </div>
                    <div class="glass p-6 rounded-2xl border-t-4 card relative overflow-hidden group" style="border-color: var(--brand-500)">
                        <div class="absolute right-0 top-0 p-4 text-slate-100 group-hover:text-slate-200 transition-colors"><i class="fas fa-calculator text-6xl opacity-20 transform rotate-12"></i></div>
                        <p class="text-[10px] font-bold uppercase tracking-wider mb-1 relative z-10" style="color: #6B7280">Ticket M√©dio</p>
                        <h3 class="text-4xl font-black relative z-10" style="color: var(--layout-text)" id="kAvg">R$ 0</h3>
                    </div>
                </div>

                <div id="chartsGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>

                <div class="glass rounded-2xl overflow-hidden shadow-sm border break-before-page" style="border-color: var(--layout-border)">
                    <div class="px-6 py-5 border-b flex justify-between items-center" style="border-color: var(--layout-border); background: var(--layout-accent)">
                        <h4 class="font-bold text-xs uppercase tracking-wide flex items-center gap-2" style="color: var(--layout-text)">
                            <i class="fas fa-table text-slate-400"></i> Detalhamento
                        </h4>
                        <span class="border px-3 py-1 rounded-full text-[10px] font-bold text-slate-500 shadow-sm" style="background: var(--layout-card); border-color: var(--layout-border)" id="tableCount">0</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="border-b text-[9px] uppercase font-black text-slate-500 tracking-wider" style="background: var(--layout-accent); border-color: var(--layout-border)">
                                <tr>
                                    <th class="px-6 py-4">Processo (CNJ)</th>
                                    <th class="px-6 py-4">Partes</th>
                                    <th class="px-6 py-4">Pedidos / Objetos</th>
                                    <th class="px-6 py-4">Filial</th>
                                    <th class="px-6 py-4 text-right">Valor</th>
                                </tr>
                            </thead>
                            <tbody id="dataTable" class="divide-y text-xs" style="--tw-divide-opacity: 1; divide-color: var(--layout-border); color: var(--layout-text)"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="mapModal" class="fixed inset-0 z-[70] hidden items-center justify-center p-6 modal-overlay">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden">
            <div class="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-white">
                <div><h3 class="font-bold text-lg text-slate-800">Mapeamento de Dados</h3><p class="text-xs text-slate-500 mt-1">Vincule as colunas da planilha.</p></div>
                <div class="w-10 h-10 rounded-full bg-brand-50 flex items-center justify-center text-brand-600" style="background-color: #eef2ff"><i class="fas fa-sitemap"></i></div>
            </div>
            <div id="mapBody" class="p-8 grid grid-cols-1 md:grid-cols-2 gap-6 overflow-y-auto bg-slate-50/30"></div>
            <div class="px-8 py-5 border-t border-slate-100 flex justify-end gap-3 bg-white">
                <button onclick="processData()" class="bg-brand-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all text-sm flex items-center gap-2" style="background-color: var(--brand-600)"><i class="fas fa-rocket"></i> Confirmar</button>
            </div>
        </div>
    </div>

    <div id="detailModal" class="fixed inset-0 z-[80] hidden items-center justify-center p-4 modal-overlay" onclick="closeDetail()">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100 flex flex-col max-h-[90vh]" onclick="event.stopPropagation()">
            <div class="px-8 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 shrink-0">
                <h3 class="font-bold text-slate-800 flex items-center gap-3 text-lg"><span id="detTitle">Ficha do Processo</span></h3>
                <button onclick="closeDetail()" class="text-slate-400 hover:text-rose-500 text-xl"><i class="fas fa-times"></i></button>
            </div>
            <div id="detBody" class="p-8 grid grid-cols-1 md:grid-cols-2 gap-y-6 gap-x-12 overflow-y-auto text-slate-700"></div>
        </div>
    </div>

    <script>
        const LEXOPS_LOGO_URL = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 90'%3E%3Cdefs%3E%3ClinearGradient id='g1' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%235b21b6;stop-opacity:1'/%3E%3Cstop offset='50%25' style='stop-color:%237c3aed;stop-opacity:1'/%3E%3Cstop offset='100%25' style='stop-color:%23a855f7;stop-opacity:1'/%3E%3C/linearGradient%3E%3Cfilter id='shadow'%3E%3CfeDropShadow dx='0' dy='4' stdDeviation='8' flood-opacity='0.4'/%3E%3C/filter%3E%3C/defs%3E%3Crect width='320' height='90' fill='url(%23g1)' rx='12'/%3E%3Cg filter='url(%23shadow)'%3E%3Ctext x='160' y='48' font-family='Inter,Arial,sans-serif' font-size='38' font-weight='900' fill='white' text-anchor='middle' letter-spacing='3'%3ELexOps%3C/text%3E%3Ctext x='160' y='72' font-family='Inter,Arial,sans-serif' font-size='13' font-weight='700' fill='rgba(255,255,255,0.85)' text-anchor='middle' letter-spacing='5'%3EINSIGHT%3C/text%3E%3C/g%3E%3C/svg%3E";

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GLOBAL STATE (Mutable Application State)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let dStore = []; 
        let customCharts = [];
        let colMapping = {};
        let filterState = {}; 
        let activeChartFilters = {};
        let logoData = { office: null, client: null, lexops: LEXOPS_LOGO_URL };
        let themeConfig = { brand: '#4f46e5', paletteName: 'indigo', palette: ['#4f46e5', '#6366f1', '#818cf8', '#a5b4fc', '#c7d2fe'] };
        let layoutTheme = 'minimal';
        let chartInstances = {};
        let rawHeaders = [];
        let numericColumns = [];
        let mappedValueColumn = null;

        const PALETTES = {
            indigo: ['#4f46e5', '#6366f1', '#818cf8', '#a5b4fc', '#c7d2fe'],
            ocean: ['#0891b2', '#06b6d4', '#22d3ee', '#67e8f9', '#a5f3fc'],
            sunset: ['#ea580c', '#f97316', '#fb923c', '#fdba74', '#fed7aa'],
            forest: ['#0f766e', '#14b8a6', '#2dd4bf', '#5eead4', '#99f6e4'],
            night: ['#3b0764', '#581c87', '#7e22ce', '#a855f7', '#d8b4fe'],
            rose: ['#be123c', '#e11d48', '#f43f5e', '#fb7185', '#fda4af'],
            gold: ['#92400e', '#b45309', '#d97706', '#f59e0b', '#fbbf24'],
            slate: ['#334155', '#475569', '#64748b', '#94a3b8', '#cbd5e1'],
            emerald: ['#047857', '#059669', '#10b981', '#34d399', '#6ee7b7'],
            crimson: ['#881337', '#9f1239', '#be123c', '#e11d48', '#f43f5e']
        };

        const LAYOUT_THEMES = {
            minimal: { bg: '#F9FAFB', card: '#ffffff', text: '#111827', border: '#E5E7EB', accent: '#F3F4F6', sidebar: '#0f172a', sidebarText: '#f8fafc', sidebarBorder: '#1e293b' },
            slate: { bg: '#F1F5F9', card: '#ffffff', text: '#0F172A', border: '#CBD5E1', accent: '#E2E8F0', sidebar: '#334155', sidebarText: '#f1f5f9', sidebarBorder: '#475569' },
            midnight: { bg: '#0F172A', card: '#1E293B', text: '#F1F5F9', border: '#334155', accent: '#1E293B', sidebar: '#020617', sidebarText: '#e2e8f0', sidebarBorder: '#0f172a' },
            cream: { bg: '#FEF3E2', card: '#FFFFFF', text: '#451a03', border: '#F3D5A7', accent: '#FDF8F0', sidebar: '#92400e', sidebarText: '#fef3e2', sidebarBorder: '#b45309' },
            ocean: { bg: '#E0F2FE', card: '#FFFFFF', text: '#0C4A6E', border: '#7DD3FC', accent: '#F0F9FF', sidebar: '#0369a1', sidebarText: '#e0f2fe', sidebarBorder: '#0284c7' },
            forest: { bg: '#DCFCE7', card: '#FFFFFF', text: '#14532D', border: '#86EFAC', accent: '#F0FDF4', sidebar: '#15803d', sidebarText: '#dcfce7', sidebarBorder: '#16a34a' },
            lavender: { bg: '#F3E8FF', card: '#FFFFFF', text: '#581C87', border: '#D8B4FE', accent: '#FAF5FF', sidebar: '#7e22ce', sidebarText: '#f3e8ff', sidebarBorder: '#9333ea' },
            ink: { bg: '#DBEAFE', card: '#FFFFFF', text: '#1E3A8A', border: '#93C5FD', accent: '#EFF6FF', sidebar: '#1e40af', sidebarText: '#dbeafe', sidebarBorder: '#2563eb' }
        };

        const FIELDS = {
            Numero: ['cnj', 'processo', 'nro', 'numero', 'pasta', 'judicial', 'id', 'refer√™ncia', 'referencia', 'n√∫mero'],
            Cliente: ['cliente', 'empresa', 'polo ativo', 'requerente', 'autor'],
            Filial: ['filial', 'unidade', 'site', 'centro de custo', 'centro', 'custo', 'divis√£o', 'divisao', 'regional'],
            Parte: ['adverso', 'reclamante', 'reu', 'r√©u', 'contraria', 'contr√°ria', 'polo passivo', 'reclamado', 'requerido'],
            Valor: ['valor', 'causa', 'principal', 'risco', 'montante', 'condena√ß√£o', 'condenacao', 'conting√™ncia', 'contingencia', 'atualizado', 'pedido', 'provisionamento', 'provis√£o', 'provisao'],
            Area: ['area', '√°rea', 'ramo', 'natureza', 'assunto', 'classe', 'mat√©ria', 'materia', 'especialidade'],
            Risco: ['risco', 'prognostico', 'progn√≥stico', 'probabilidade', 'perda', 'parecer', 'classifica√ß√£o', 'classificacao'],
            Objeto: ['objeto', 'pedido', 'pleitos', 'assunto', 'descri√ß√£o', 'descricao', 'causa de pedir', 'tese'],
            // Optional fields (multiple values support)
            Condena√ß√£o: ['condena√ß√£o', 'condenacao', 'condenado', 'senten√ßa', 'sentenca', 'julgado'],
            Acordo: ['acordo', 'acor√ßado', 'transa√ß√£o', 'transacao', 'concilia√ß√£o', 'conciliacao', 'media√ß√£o', 'mediacao'],
            Provis√£o: ['provis√£o', 'provisao', 'reserva', 'estimativa', 'previs√£o', 'previsao', 'expectativa']
        };

        function b64DecodeUnicode(str) {
            try {
                return decodeURIComponent(Array.prototype.map.call(atob(str), function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
            } catch (e) { console.error("Erro decode:", e); return "[]"; }
        }

        function b64EncodeUnicode(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
                return String.fromCharCode('0x' + p1);
            }));
        }

        function isNumericColumn(data, colName) {
            const sample = data.slice(0, Math.min(50, data.length));
            let numericCount = 0;
            for (let row of sample) {
                const val = row[colName];
                if (val !== null && val !== undefined && val !== '') {
                    const parsed = parseVal(val);
                    if (!isNaN(parsed) && parsed !== 0) numericCount++;
                }
            }
            return numericCount > sample.length * 0.3;
        }

        function formatValue(val, colName) {
            const lowerCol = (colName || '').toLowerCase();
            if (lowerCol.includes('valor') || lowerCol.includes('montante') || lowerCol.includes('causa')) {
                return fmtMoney(val);
            }
            if (val >= 1000000) return (val / 1000000).toFixed(1) + 'M';
            if (val >= 1000) return (val / 1000).toFixed(1) + 'K';
            return val.toFixed(0);
        }

        function parseVal(v) {
            if(!v) return 0;
            if(typeof v==='number') return v;
            const s = String(v).replace(/[R$\s]/g,'');
            if(s.includes(',') && s.lastIndexOf(',') > s.lastIndexOf('.')) return parseFloat(s.replace(/\./g,'').replace(',','.'))||0;
            return parseFloat(s.replace(/,/g,''))||0;
        }

        function fmtMoney(v) { return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }

        const debounce = (fn, delay = 150) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => fn(...args), delay);
            };
        };

        const setLoadingState = (isLoading) => {
            document.body.style.cursor = isLoading ? 'wait' : 'default';
        };

        const updateCSSVar = (varName, value) => {
            requestAnimationFrame(() => {
                document.documentElement.style.setProperty(varName, value);
            });
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // HYDRATED STATE BOOT ARCHITECTURE
        // Offline-First SPA: Detects Admin Mode vs Client Mode
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        (function BOOT() {
            'use strict';

            const BOOT_STATE = {
                isOfflineMode: !!window.__OFFLINE_PAYLOAD__,
                isDOMReady: false
            };

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', bootApplication);
            } else {
                bootApplication();
            }

            function bootApplication() {
                try {
                    BOOT_STATE.isDOMReady = true;

                    if (BOOT_STATE.isOfflineMode) {
                        bootClientMode();
                    } else {
                        bootAdminMode();
                    }
                } catch (error) {
                    console.error('üí• Boot failed:', error);
                    alert('Erro ao inicializar o sistema.');
                }
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // CLIENT MODE: Exported HTML (Read-Only Dashboard)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            function bootClientMode() {
                try {
                    const payload = window.__OFFLINE_PAYLOAD__;

                    // Hydrate state
                    dStore = payload.dStore || [];
                    customCharts = payload.customCharts || [];
                    themeConfig = payload.themeConfig || {};
                    colMapping = payload.colMapping || {};
                    logoData = payload.logoData || {};
                    layoutTheme = payload.layoutTheme || 'minimal';
                    numericColumns = payload.numericColumns || [];
                    mappedValueColumn = payload.mappedValueColumn || null;

                    // Hide admin UI
                    const sidebar = document.getElementById('adminPanel');
                    if (sidebar) sidebar.style.display = 'none';

                    // Full-width main
                    const main = document.querySelector('main');
                    if (main) {
                        main.style.width = '100% !important';
                        main.style.margin = '0 !important';
                    }

                    // Render
                    document.body.classList.add('client-mode');
                    applyTheme();
                    applyLayoutTheme();
                    applyLogos();
                    applyLexOpsLogo();
                    initFiltersUI();
                    renderAll();

                } catch (err) {
                    console.error('Client mode boot failed:', err);
                }
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // ADMIN MODE: Upload & Editor Interface
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            function bootAdminMode() {
                try {
                    if (!window.XLSX) {
                        throw new Error('SheetJS not loaded');
                    }

                    initializeExcelUpload();
                    initializeLogoUploads();
                    initializeWhiteLabelControls();
                    applyVisualEnhancements();

                } catch (error) {
                    console.error('Admin mode boot failed:', error);
                    alert('Erro ao inicializar o sistema.');
                }
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // EXCEL UPLOAD: Robust SheetJS Integration
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            function initializeExcelUpload() {
                const fileInput = document.getElementById('fileInput');
                if (!fileInput) return;

                fileInput.addEventListener('change', async (event) => {
                    const file = event.target?.files?.[0];
                    if (!file) return;

                    setLoadingState(true);

                    try {
                        // Validation
                        if (!file.name.match(/\.(xlsx?|csv)$/i)) {
                            throw new Error('Formato inv√°lido. Use XLSX, XLS ou CSV.');
                        }
                        if (file.size > 50 * 1024 * 1024) {
                            throw new Error('Arquivo muito grande (m√°x. 50MB).');
                        }

                        // Parse
                        const arrayBuffer = await readFileAsArrayBuffer(file);
                        const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                        if (!workbook.SheetNames.length) {
                            throw new Error('Planilha vazia ou corrompida.');
                        }

                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rawData = XLSX.utils.sheet_to_json(firstSheet);

                        if (!rawData || !rawData.length) {
                            throw new Error('Nenhum dado encontrado na planilha.');
                        }

                        // Success
                        rawHeaders = Object.keys(rawData[0]);
                        window._tempRaw = rawData;
                        showMapping();

                    } catch (error) {
                        alert(`‚ùå ${error.message}`);
                        console.error(error);
                    } finally {
                        setLoadingState(false);
                        fileInput.value = '';
                    }
                });
            }

            const readFileAsArrayBuffer = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('Falha ao ler arquivo.'));
                    reader.readAsArrayBuffer(file);
                });
            };

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // LOGO UPLOADS: Memory-Safe Handlers
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            function initializeLogoUploads() {
                const configs = [
                    { id: 'logoOffice', key: 'office' },
                    { id: 'logoClient', key: 'client' },
                    { id: 'lexopsMainLogo', key: 'lexops' }
                ];

                configs.forEach(({ id, key }) => {
                    const input = document.getElementById(id);
                    if (!input) return;

                    input.addEventListener('change', async (event) => {
                        const file = event.target?.files?.[0];
                        if (!file) return;

                        try {
                            if (!file.name.match(/\.(jpg|jpeg|png|svg|webp)$/i)) {
                                throw new Error('Formato inv√°lido. Use JPG, PNG ou SVG.');
                            }
                            if (file.size > 5 * 1024 * 1024) {
                                throw new Error('Imagem muito grande (m√°x. 5MB).');
                            }

                            const dataURL = await readFileAsDataURL(file);
                            logoData[key] = dataURL;
                            applyLogos();

                        } catch (error) {
                            alert(`‚ùå ${error.message}`);
                        } finally {
                            input.value = '';
                        }
                    });
                });
            }

            const readFileAsDataURL = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('Falha ao ler imagem.'));
                    reader.readAsDataURL(file);
                });
            };

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // REAL-TIME COLOR MOTOR: requestAnimationFrame + Input Event
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            function initializeWhiteLabelControls() {
                // Color inputs (instant feedback via RAF)
                const colorControls = [
                    { id: 'accentColorInput', varName: '--primary-accent' },
                    { id: 'headerBgInput', handler: updateHeaderBg },
                    { id: 'headerTextInput', varName: '--header-text' }
                ];

                colorControls.forEach(({ id, varName, handler }) => {
                    const input = document.getElementById(id);
                    if (!input) return;

                    input.addEventListener('input', (e) => {
                        if (handler) {
                            handler(e.target.value);
                        } else if (varName) {
                            updateCSSVar(varName, e.target.value);
                        }
                    });
                });

                // Text inputs (debounced)
                const textControls = [
                    { id: 'panelTitleInput', handler: updatePanelTitle },
                    { id: 'footerTextInput', handler: updateFooterText }
                ];

                textControls.forEach(({ id, handler }) => {
                    const input = document.getElementById(id);
                    if (!input) return;
                    input.addEventListener('input', debounce((e) => handler(e.target.value), 100));
                });

                // Opacity slider
                const opacityInput = document.getElementById('headerOpacityInput');
                if (opacityInput) {
                    opacityInput.addEventListener('input', (e) => updateHeaderOpacity(e.target.value));
                }
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // VISUAL ENHANCEMENTS: HDR & Premium CSS
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            function applyVisualEnhancements() {
                const style = document.createElement('style');
                style.textContent = `
                    /* HDR Shadows & Glassmorphism */
                    .metric-card, .chart-container, .card, .glass {
                        box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.08), 
                                   0 4px 10px -5px rgba(0, 0, 0, 0.04) !important;
                        border: 1px solid rgba(255, 255, 255, 0.6) !important;
                        backdrop-filter: blur(10px) !important;
                    }

                    /* Inter Typography */
                    body, input, button, select, textarea {
                        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
                        -webkit-font-smoothing: antialiased !important;
                        -moz-osx-font-smoothing: grayscale !important;
                    }

                    /* Premium Buttons */
                    button {
                        transition: all 0.2s ease !important;
                    }
                    button:hover {
                        transform: translateY(-2px) !important;
                        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12) !important;
                    }
                `;
                document.head.appendChild(style);
            }

        })();

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EXPORT ENGINE: Intelligent Client-Side Build Pipeline
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function exportConsolidatedHTML() {
            // Sanity check
            if (!dStore || dStore.length === 0) {
                alert('‚ö†Ô∏è Nenhum dado para exportar. Importe uma planilha primeiro.');
                return;
            }

            const clone = document.documentElement.cloneNode(true);
            const body = clone.querySelector('body');

            // === SANITIZA√á√ÉO DE EXPORTA√á√ÉO ===
            // 1. Remove ferramentas de Admin (O cliente n√£o deve ver isso)
            const adminPanel = clone.querySelector('#adminPanel');
            if(adminPanel) adminPanel.remove();

            // 2. Remove √°rea de Upload
            const dropZone = clone.querySelector('#dropZone');
            if(dropZone) dropZone.remove();

            // 3. Remove script de API (O cliente n√£o precisa validar token, pois j√° tem os dados)
            const authScript = clone.querySelector('#auth-logic');
            if(authScript) authScript.remove();

            // 4. Persiste o tamanho da logo escolhida
            const size = getComputedStyle(document.documentElement).getPropertyValue('--logo-height');
            const styleTag = clone.querySelector('style');
            if(styleTag) styleTag.innerHTML += `:root{--logo-height:${size};}`;

            // Step 1: Enable client mode
            if (body) {
                body.classList.add('client-mode');
            }

            // Step 2: Sanitization (Remove admin UI)
            ['#adminPanel', '.no-export'].forEach(selector => {
                clone.querySelectorAll(selector).forEach(el => el.remove());
            });

            // CRITICAL: KEEP #clientControls (filter bar)
            // Do NOT remove it

            // Step 3: State Injection (Hydration)
            const offlinePayloadScript = document.createElement('script');
            offlinePayloadScript.textContent = `
                window.__OFFLINE_PAYLOAD__ = {
                    dStore: ${JSON.stringify(dStore)},
                    customCharts: ${JSON.stringify(customCharts)},
                    themeConfig: ${JSON.stringify(themeConfig)},
                    colMapping: ${JSON.stringify(colMapping)},
                    logoData: ${JSON.stringify(logoData)},
                    layoutTheme: '${layoutTheme}',
                    numericColumns: ${JSON.stringify(numericColumns)},
                    mappedValueColumn: ${mappedValueColumn ? JSON.stringify(mappedValueColumn) : 'null'}
                };
            `;

            const head = clone.querySelector('head');
            if (head) head.appendChild(offlinePayloadScript);

            // Step 4: CSS Freeze (Color Persistence)
            const cssVarsStyle = document.createElement('style');
            const primaryAccent = getComputedStyle(document.documentElement).getPropertyValue('--primary-accent').trim() || '#4f46e5';
            const headerBgRgb = getComputedStyle(document.documentElement).getPropertyValue('--header-bg-rgb').trim() || '255,255,255';
            const headerText = getComputedStyle(document.documentElement).getPropertyValue('--header-text').trim() || '#111827';
            const headerOpacity = getComputedStyle(document.documentElement).getPropertyValue('--header-opacity').trim() || '1';

            cssVarsStyle.textContent = `
                :root {
                    --primary-accent: ${primaryAccent};
                    --header-bg-rgb: ${headerBgRgb};
                    --header-text: ${headerText};
                    --header-opacity: ${headerOpacity};
                }
                #imgClient, #imgOffice, #lexopsLogoImg {
                    background: transparent !important;
                    border: 0px none !important;
                    box-shadow: none !important;
                    outline: none !important;
                    max-height: 50px !important;
                    object-fit: contain !important;
                    margin: 0 15px !important;
                    padding: 0 !important;
                }
                .header-section {
                    border: none !important;
                    box-shadow: none !important;
                }
            `;
            if (head) head.appendChild(cssVarsStyle);

            // Step 5: Logo Blindage (Inline styles)
            ['#imgClient', '#imgOffice', '#lexopsLogoImg', 'img[id*="Client"]', 'img[id*="Office"]'].forEach(selector => {
                clone.querySelectorAll(selector).forEach(logo => {
                    logo.style.cssText = 'background: transparent !important; ' +
                                        'border: 0px none !important; ' +
                                        'box-shadow: none !important; ' +
                                        'outline: none !important; ' +
                                        'max-height: 50px !important; ' +
                                        'object-fit: contain !important; ' +
                                        'margin: 0 15px !important; ' +
                                        'padding: 0 !important;';
                });
            });

            // Step 6: Footer Injection
            if (body) {
                const footerInput = document.getElementById('footerTextInput');
                const footerText = footerInput && footerInput.value.trim() ? footerInput.value : 'Powered by LexOps Insight';

                const footer = document.createElement('div');
                footer.style.cssText = 'width: 100%; ' +
                                      'text-align: center; ' +
                                      'padding: 20px 0; ' +
                                      'margin-top: 40px; ' +
                                      'border-top: 1px solid #e5e7eb; ' +
                                      'color: #9ca3af; ' +
                                      'font-size: 11px; ' +
                                      'font-family: sans-serif; ' +
                                      'clear: both; ' +
                                      'box-sizing: border-box;';
                footer.innerHTML = `<p style="margin: 0; font-weight: 500;">${footerText}</p>`;
                body.appendChild(footer);
            }

            // Step 7: Download
            const htmlContent = `<!DOCTYPE html>\n${clone.outerHTML}`;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'Dashboard_Juridico_LexOpsInsight.html';
            a.click();

            setTimeout(() => URL.revokeObjectURL(a.href), 100);
        
        };

        function applyLexOpsLogo() {
            const img = document.getElementById('lexopsLogoImg');
            const fallback = document.getElementById('lexopsLogoFallback');
            
            if(!img) return;
            
            requestAnimationFrame(() => {
                img.style.display = 'block';
                img.src = 'assets/img/logo-lexops.png';
                
                if(fallback) fallback.style.display = 'none';
                
                // If custom logo uploaded, use it
                if(logoData?.lexops) {
                    img.src = logoData.lexops;
                    img.onload = function() { 
                        this.style.display = 'block';
                        if(fallback) fallback.style.display = 'none';
                    };
                    img.onerror = function() {
                        this.src = 'assets/img/logo-lexops.png';
                    };
                }
            });
        }

        ['logoOffice', 'logoClient', 'lexopsMainLogo'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.addEventListener('change', e => {
                    const r = new FileReader();
                    r.onload = ev => { 
                        if(id.includes('Office')) logoData.office = ev.target.result; 
                        else if(id.includes('Client')) logoData.client = ev.target.result;
                        else if(id.includes('Main')) logoData.lexops = ev.target.result;
                        applyLogos(); 
                    };
                    if(e.target.files[0]) r.readAsDataURL(e.target.files[0]);
                });
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // LOGO APPLICATION (Memory-Safe with RAF)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function applyLogos() {
            // Gerencia APENAS Cliente e Escrit√≥rio
            if(logoData.office) { 
                const img = document.getElementById('imgOffice'); 
                const wrap = document.getElementById('wrapOffice');
                const ph = document.getElementById('phOffice');
                if(img && wrap) {
                    requestAnimationFrame(() => {
                        img.src = logoData.office; 
                        wrap.classList.remove('hidden'); 
                        wrap.style.display = 'inline-flex'; 
                        if(ph) ph.classList.add('hidden'); 
                    });
                }
            }
            
            if(logoData.client) { 
                const img = document.getElementById('imgClient'); 
                const wrap = document.getElementById('wrapClient');
                const ph = document.getElementById('phClient');
                if(img && wrap) {
                    requestAnimationFrame(() => {
                        img.src = logoData.client; 
                        wrap.classList.remove('hidden'); 
                        wrap.style.display = 'inline-flex';
                        if(ph) ph.classList.add('hidden'); 
                    });
                }
            }
        }

        function showMapping() {
            const body = document.getElementById('mapBody'); 
            body.innerHTML = '';
            body.className = 'p-8 grid grid-cols-1 md:grid-cols-2 gap-6 overflow-y-auto bg-slate-50';
            
            // All fields (no more mandatory/optional distinction for UX)
            const allFields = ['Numero', 'Cliente', 'Filial', 'Parte', 'Valor', 'Area', 'Risco', 'Objeto', 'Condena√ß√£o', 'Acordo', 'Provis√£o'];
            
            // Default display names
            if(!window.displayLabels) {
                window.displayLabels = {
                    'Numero': 'N√∫mero do Processo',
                    'Cliente': 'Cliente',
                    'Filial': 'Filial',
                    'Parte': 'Parte Adversa',
                    'Valor': 'Valor da Causa',
                    'Area': '√Årea do Direito',
                    'Risco': 'Classifica√ß√£o de Risco',
                    'Objeto': 'Objeto/Pedidos',
                    'Condena√ß√£o': 'Valor de Condena√ß√£o',
                    'Acordo': 'Valor de Acordo',
                    'Provis√£o': 'Provis√£o Cont√°bil'
                };
            }
            
            allFields.forEach(f => {
                let best = '';
                for(let header of rawHeaders) {
                    const headerLower = header.toLowerCase();
                    const fieldSynonyms = FIELDS[f] || [f.toLowerCase()];
                    for(let synonym of fieldSynonyms) {
                        if(headerLower.includes(synonym.toLowerCase())) {
                            best = header;
                            break;
                        }
                    }
                    if(best) break;
                }

                const cardHTML = `
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-5 hover:shadow-md transition-all group">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1 flex items-center gap-2">
                                <input type="text" 
                                       id="label_${f}" 
                                       value="${window.displayLabels[f]}" 
                                       class="flex-1 text-sm font-bold text-slate-700 bg-transparent border-0 outline-none px-2 py-1 rounded hover:bg-slate-50 focus:bg-white focus:border focus:border-slate-300 transition-all"
                                       placeholder="Nome do campo...">
                                <i class="fas fa-pencil text-slate-300 group-hover:text-brand-500 text-xs transition-colors"></i>
                            </div>
                            <span id="badge_${f}" class="text-[9px] px-2 py-1 rounded-full font-bold bg-slate-100 text-slate-500">Opcional</span>
                        </div>
                        <select id="map_${f}" 
                                onchange="updateMappingStatus('${f}', this.value)" 
                                class="w-full border border-slate-200 p-2.5 rounded-lg text-xs focus:ring-2 focus:ring-brand-500 bg-white outline-none transition-all">
                            <option value="">(N√£o Mapear)</option>
                            ${rawHeaders.map(h => `<option value="${h}" ${h===best?'selected':''}>${h}</option>`).join('')}
                        </select>
                        <div id="prev_${f}" class="mt-3 text-[10px] text-slate-500 bg-slate-50 p-2 rounded border border-slate-100 h-16 overflow-y-auto"></div>
                        <div class="mt-2 flex items-center gap-2">
                            <input type="checkbox" id="filter_${f}" class="w-3 h-3 cursor-pointer accent-brand-500">
                            <label for="filter_${f}" class="text-[9px] cursor-pointer text-slate-600">üìä Disponibilizar como filtro lateral</label>
                        </div>
                    </div>
                `;
                
                body.innerHTML += cardHTML;
                setTimeout(() => updateMappingStatus(f, best), 50);
            });
            
            document.getElementById('mapModal').classList.replace('hidden', 'flex');
        }

        function updateMappingStatus(field, columnValue) {
            const badge = document.getElementById(`badge_${field}`);
            const preview = document.getElementById(`prev_${field}`);
            
            if(!columnValue) { 
                badge.className = 'text-[9px] px-2 py-1 rounded-full font-bold bg-slate-100 text-slate-500';
                badge.textContent = 'Opcional';
                preview.innerHTML = '<div class="text-slate-400 italic">N√£o mapeado</div>'; 
                return; 
            }
            
            // Update badge to "Mapped"
            badge.className = 'text-[9px] px-2 py-1 rounded-full font-bold bg-emerald-100 text-emerald-700';
            badge.textContent = 'Mapeado';
            
            // Update preview
            const vals = window._tempRaw.slice(0,3).map(r=>r[columnValue]);
            preview.innerHTML = vals.map(v=>`<div class="text-brand-600 font-semibold text-[9px] mb-1">‚Ä¢ ${v||'(vazio)'}</div>`).join('');
        }

        function processData() {
            // Save custom labels
            const allFields = ['Numero', 'Cliente', 'Filial', 'Parte', 'Valor', 'Area', 'Risco', 'Objeto', 'Condena√ß√£o', 'Acordo', 'Provis√£o'];
            allFields.forEach(f => {
                const labelInput = document.getElementById(`label_${f}`);
                if(labelInput) {
                    window.displayLabels[f] = labelInput.value || f;
                }
            });
            
            const maps = {};
            Object.keys(FIELDS).forEach(f => {
                const elem = document.getElementById(`map_${f}`);
                maps[f] = elem ? elem.value : '';
            });
            
            colMapping = maps;
            mappedValueColumn = maps.Valor;
            numericColumns = rawHeaders.filter(h => isNumericColumn(window._tempRaw, h));

            // Removed mandatory validation - all fields are optional now
            let emptyVals = 0;
            const limit = Math.min(window._tempRaw.length, 100);
            for(let i=0; i<limit; i++) if(!window._tempRaw[i][maps.Valor]) emptyVals++;
            if(emptyVals > limit*0.5) if(!confirm("Aten√ß√£o: Mais de 50% dos registros n√£o possuem valor financeiro. Continuar?")) return;

            // ANTI-DUPLICITY: Deduplication by ID (N√∫mero/Processo)
            // If ID repeats: DON'T count new process. SUM financial values. CONCATENATE objects.
            const dedupeMap = new Map();
            
            // Collect optional fields from Smart Mapper checkboxes
            const optionalFields = {};
            ['Condena√ß√£o', 'Acordo', 'Provis√£o'].forEach(f => {
                const checkbox = document.getElementById(`filter_${f}`);
                if(checkbox && checkbox.checked) {
                    optionalFields[f] = maps[f] || null;
                }
            });
            window._filterableFields = optionalFields;

            window._tempRaw.forEach(r => {
                const numId = String(r[maps.Numero] || '').trim();
                if(!numId || numId === 'N/D') return;

                const objRaw = r[maps.Objeto];
                let objList = ['N/D'];
                if(objRaw) {
                    const str = String(objRaw);
                    // SPLITTER: Detect separators (;, /, |) as independent tags
                    objList = str.split(/[\n;|/]+/).map(s=>s.trim().replace(/^[-‚Ä¢]\s*/,'')).filter(s=>s.length>2);
                    if(objList.length===0) objList = [str.trim()];
                }
                const filial = r[maps.Filial] || 'Matriz';

                if(dedupeMap.has(numId)) {
                    // DUPLICATE FOUND: Aggregate values + concatenate objects
                    const existing = dedupeMap.get(numId);
                    existing.Valor += parseVal(r[maps.Valor]);
                    existing._duplicateCount = (existing._duplicateCount || 1) + 1;
                    
                    // Concatenate unique objects
                    objList.forEach(obj => {
                        if(!existing._objectsList.includes(obj)) {
                            existing._objectsList.push(obj);
                        }
                    });
                    
                    // Aggregate optional field values
                    Object.keys(optionalFields).forEach(f => {
                        const val = r[maps[f]];
                        if(val) {
                            if(!existing[f]) existing[f] = [];
                            if(!Array.isArray(existing[f])) existing[f] = [existing[f]];
                            existing[f].push(val);
                        }
                    });
                } else {
                    // NEW RECORD: Create entry
                    const newRecord = {
                        Numero: numId,
                        Cliente: r[maps.Cliente] || 'Geral',
                        Filial: filial,
                        Parte: r[maps.Parte] || 'N/D',
                        Valor: parseVal(r[maps.Valor]),
                        Area: r[maps.Area] || 'C√≠vel',
                        Risco: r[maps.Risco] || 'Poss√≠vel',
                        Objeto: objRaw || 'N/D',
                        _objectsList: objList,
                        _duplicateCount: 1,
                        _searchText: Object.values(r).join(' ').toLowerCase(),
                        _allData: r 
                    };
                    
                    // Initialize optional fields
                    Object.keys(optionalFields).forEach(f => {
                        const val = r[maps[f]];
                        if(val) {
                            newRecord[f] = [val];
                        }
                    });
                    
                    dedupeMap.set(numId, newRecord);
                }
            });

            // Convert Map to Array (deduplication complete)
            dStore = Array.from(dedupeMap.values());

            const uniqueAreas = [...new Set(dStore.map(d=>d.Area))];
            const uniqueRiscos = [...new Set(dStore.map(d=>d.Risco))];
            const uniqueFiliais = [...new Set(dStore.map(d=>d.Filial))];

            customCharts = [];
            
            if(uniqueAreas.length > 1) {
                customCharts.push({ id: 'c1', x: 'Area', y: 'sum', yCol: mappedValueColumn, type: 'bar_h', title: 'Exposi√ß√£o Financeira por √Årea' });
            }

            if(uniqueRiscos.length > 1) {
                customCharts.push({ id: 'c2', x: 'Risco', y: 'count', yCol: null, type: 'line', title: 'Volume de Processos por Risco' });
            } else if(uniqueFiliais.length > 1) {
                customCharts.push({ id: 'c2', x: 'Filial', y: 'count', yCol: null, type: 'line', title: 'Volume por Filial' });
            }

            if(uniqueRiscos.length > 1) {
                customCharts.push({ id: 'c3', x: 'Risco', y: 'sum', yCol: mappedValueColumn, type: 'doughnut', title: 'Distribui√ß√£o de Valores por Risco' });
            }

            if(uniqueFiliais.length > 1) {
                customCharts.push({ id: 'c4', x: 'Filial', y: 'sum', yCol: mappedValueColumn, type: 'bar', title: 'An√°lise Financeira de Filiais' });
            }

            if(customCharts.length < 2) {
                if(customCharts.length === 0) {
                    customCharts.push({ id: 'c1', x: 'Area', y: 'sum', yCol: mappedValueColumn, type: 'bar_h', title: 'Exposi√ß√£o Financeira' });
                }
                customCharts.push({ id: 'c2', x: 'Risco', y: 'count', yCol: null, type: 'line', title: 'Volume de Processos' });
            }

            document.getElementById('mapModal').classList.replace('flex', 'hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('dashContent').classList.remove('hidden');
            
            populateChartBuilder();
            initFiltersUI();
            renderAll();
        }

        function populateChartBuilder() {
            const biX = document.getElementById('biX');
            const biYCol = document.getElementById('biYCol');
            
            if(!biX || !biYCol) return;

            const categoricalCols = ['Area', 'Risco', 'Filial', 'Cliente', 'Parte', 'Objeto'];
            biX.innerHTML = categoricalCols.map(col => `<option value="${col}">${col}</option>`).join('');
            
            if(rawHeaders.length > 0) {
                rawHeaders.forEach(h => {
                    if(!categoricalCols.includes(h)) {
                        biX.innerHTML += `<option value="${h}">${h}</option>`;
                    }
                });
            }

            // Y-axis: Include ALL columns from rawHeaders (not just numeric)
            biYCol.innerHTML = '';
            if(rawHeaders && rawHeaders.length > 0) {
                rawHeaders.forEach(col => {
                    const selected = col === mappedValueColumn ? 'selected' : '';
                    biYCol.innerHTML += `<option value="${col}" ${selected}>${col}</option>`;
                });
            } else if(mappedValueColumn) {
                biYCol.innerHTML = `<option value="${mappedValueColumn}" selected>${mappedValueColumn}</option>`;
            } else {
                biYCol.innerHTML = '<option value="Valor">Valor</option>';
            }
        }

        function initFiltersUI() {
            const ca = document.getElementById('filtersContainer');
            const cc = document.getElementById('clientFilters'); 
            
            if(ca) ca.innerHTML = '';
            if(cc) cc.innerHTML = '';

            if(!dStore || dStore.length === 0) return;

            document.addEventListener('click', function(e) {
                if(!e.target.closest('.filter-group-btn')) {
                    document.querySelectorAll('.filter-dropdown').forEach(el => el.classList.add('hidden'));
                }
            });

            // Include both standard filters AND optional fields selected by user
            const standardDims = ['Cliente','Filial','Area','Risco','Objeto'];
            const optionalDims = window._filterableFields ? Object.keys(window._filterableFields).filter(f => window._filterableFields[f]) : [];
            const allDims = [...standardDims, ...optionalDims];

            allDims.forEach(dim => {
                let vals = [];
                if(dim==='Objeto') vals = [...new Set(dStore.flatMap(d=>d._objectsList))].sort();
                else if(optionalDims.includes(dim)) {
                    // For optional fields, extract from arrays
                    vals = [...new Set(dStore.flatMap(d => {
                        const val = d[dim];
                        return Array.isArray(val) ? val : (val ? [val] : []);
                    }))].sort();
                } else {
                    vals = [...new Set(dStore.map(d=>d[dim]))].sort();
                }

                if(vals.length > 0) {
                    if(ca) {
                        let htmlA = `<div class="mb-5 border-b pb-3" style="border-color: var(--layout-sidebar-border)"><p class="text-[9px] font-black uppercase mb-2 flex justify-between admin-section-title">${dim} <span class="px-1.5 rounded-full" style="background: rgba(0,0,0,0.2); color: var(--layout-sidebar-text)">${vals.length}</span></p>`;
                        vals.forEach(v => {
                            const b64Val = b64EncodeUnicode(v);
                            const safeID = `chk_adm_${dim}_${b64Val.replace(/[^a-zA-Z0-9]/g,'')}`;
                            htmlA += `<label class="flex items-center gap-2 mb-1.5 cursor-pointer hover:bg-white/10 p-1 rounded transition-colors"><input type="checkbox" id="${safeID}" onchange="toggleF('${dim}', '${b64Val}')" class="rounded admin-checkbox focus:ring-0 w-3.5 h-3.5" style="color: var(--brand-500)"><span class="text-xs truncate admin-section-title" title="${v}">${v}</span></label>`;
                        });
                        ca.innerHTML += htmlA + `</div>`;
                    }
                    
                    if(cc) {
                        let htmlC = `
                        <div class="relative filter-group-btn">
                            <button onclick="toggleDropdown('dd_${dim}')" class="flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold hover:border-brand-500 transition-all shadow-sm" style="background: var(--layout-accent); border: 1px solid var(--layout-border); color: var(--layout-text)">
                                ${dim} <i class="fas fa-chevron-down text-[9px] text-slate-400"></i>
                            </button>
                            <div id="dd_${dim}" class="filter-dropdown absolute top-full left-0 mt-2 w-64 rounded-xl shadow-xl border hidden max-h-80 overflow-y-auto p-2 z-50" style="background: var(--layout-card); border-color: var(--layout-border)">`;
                        
                        vals.forEach(v => {
                            const b64Val = b64EncodeUnicode(v);
                            const safeID = `chk_cli_${dim}_${b64Val.replace(/[^a-zA-Z0-9]/g,'')}`;
                            htmlC += `<label class="flex items-center gap-2 p-2 cursor-pointer rounded-lg transition-colors hover:bg-opacity-10" style="hover:background: var(--layout-accent)"><input type="checkbox" id="${safeID}" onchange="toggleF('${dim}', '${b64Val}')" class="rounded focus:ring-0 w-3.5 h-3.5" style="border-color: var(--layout-border); color: var(--brand-500)"><span class="text-xs truncate leading-tight" style="color: var(--layout-text)">${v}</span></label>`;
                        });
                        cc.innerHTML += htmlC + `</div></div>`;
                    }
                }
            });
        }

        function toggleDropdown(id) {
            document.querySelectorAll('.filter-dropdown').forEach(el => {
                if(el.id !== id) el.classList.add('hidden');
            });
            document.getElementById(id).classList.toggle('hidden');
        }

        function toggleF(dim, b64Val) {
            const val = b64DecodeUnicode(b64Val);
            if(!filterState[dim]) filterState[dim]=[];
            const i = filterState[dim].indexOf(val);
            if(i>-1) filterState[dim].splice(i,1); else filterState[dim].push(val);
            
            const safeSuffix = `${dim}_${b64Val.replace(/[^a-zA-Z0-9]/g,'')}`;
            const chkAdm = document.getElementById(`chk_adm_${safeSuffix}`);
            const chkCli = document.getElementById(`chk_cli_${safeSuffix}`);
            const isChecked = (i === -1);
            if(chkAdm) chkAdm.checked = isChecked;
            if(chkCli) chkCli.checked = isChecked;

            renderAll();
        }

        function resetFilters() { 
            filterState = {}; 
            activeChartFilters = {}; 
            document.querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=false); 
            const search = document.getElementById('globalSearch');
            if(search) search.value = '';
            renderAll(); 
        }

        function resetLayout() {
            themeConfig = { brand: '#4f46e5', paletteName: 'indigo', palette: ['#4f46e5', '#6366f1', '#818cf8', '#a5b4fc', '#c7d2fe'] };
            layoutTheme = 'minimal';
            const initialCharts = customCharts.slice(0, 4);
            customCharts = initialCharts;
            const paletteSelect = document.getElementById('paletteSelect');
            if(paletteSelect) paletteSelect.value = 'indigo';
            const layoutSelect = document.getElementById('layoutThemeSelect');
            if(layoutSelect) layoutSelect.value = 'minimal';
            // Reset White Label
            document.documentElement.style.setProperty('--primary-accent', '#4f46e5');
            document.documentElement.style.setProperty('--header-bg-rgb', '255,255,255');
            document.documentElement.style.setProperty('--header-text', '#111827');
            document.documentElement.style.setProperty('--header-opacity', '1');
            if(document.getElementById('accentColorInput')) document.getElementById('accentColorInput').value = '#4f46e5';
            if(document.getElementById('panelTitleInput')) document.getElementById('panelTitleInput').value = 'An√°lise Jur√≠dica Corporativa';
            if(document.getElementById('footerTextInput')) document.getElementById('footerTextInput').value = '';
            if(document.getElementById('headerBgInput')) document.getElementById('headerBgInput').value = '#ffffff';
            if(document.getElementById('headerTextInput')) document.getElementById('headerTextInput').value = '#111827';
            if(document.getElementById('headerOpacityInput')) document.getElementById('headerOpacityInput').value = '1';
            applyTheme();
            applyLayoutTheme();
            renderAll();
        }

        // Fun√ß√µes de White Label - Identidade da Marca
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // WHITE LABEL UPDATE FUNCTIONS (Real-Time with RAF)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function updateAccentColor(color) {
            updateCSSVar('--primary-accent', color);
        }

        function updatePanelTitle(text) {
            requestAnimationFrame(() => {
                const h1 = document.querySelector('header h1') || document.querySelector('.header-center h1');
                if(h1) h1.textContent = text;
            });
        }

        function updateFooterText(text) {
            requestAnimationFrame(() => {
                const footer = document.querySelector('footer') || document.querySelector('footer p');
                if(footer) footer.textContent = text;
                else {
                    const powered = document.querySelector('.header-center p');
                    if(powered) powered.textContent = text;
                }
            });
        }

        function updateHeaderBg(color) {
            const rgb = hexToRgb(color);
            if(rgb) {
                updateCSSVar('--header-bg-rgb', `${rgb.r},${rgb.g},${rgb.b}`);
            }
        }

        function updateHeaderText(color) {
            updateCSSVar('--header-text', color);
        }

        function updateHeaderOpacity(value) {
            const numValue = parseFloat(value);
            updateCSSVar('--header-opacity', numValue);
            
            requestAnimationFrame(() => {
                const percentage = Math.round(numValue * 100);
                const opacityValueEl = document.getElementById('opacityValue');
                if(opacityValueEl) opacityValueEl.textContent = percentage + '%';
            });
        }

        // Utility: Convert HEX to RGB
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        function analisarCurvaABC(dados) {
            if (!dados || dados.length === 0) {
                document.getElementById('abcAlert').classList.add('hidden');
                return;
            }
            
            const porParte = {};
            dados.forEach(d => {
                const parte = d.Parte || 'N√£o Informado';
                porParte[parte] = (porParte[parte] || 0) + d.Valor;
            });
            
            const sortedPartes = Object.entries(porParte).sort((a,b) => b[1] - a[1]);
            const valorTotal = sortedPartes.reduce((sum, [,val]) => sum + val, 0);
            
            if (sortedPartes.length >= 3 && valorTotal > 0) {
                const top3 = sortedPartes.slice(0, 3);
                const valorTop3 = top3.reduce((sum, [,val]) => sum + val, 0);
                const percentual = (valorTop3 / valorTotal * 100).toFixed(1);
                
                if (percentual > 50) {
                    const alert = document.getElementById('abcAlert');
                    const message = document.getElementById('abcMessage');
                    
                    message.innerHTML = `<strong>Os 3 maiores litigantes</strong> concentram <strong>${fmtMoney(valorTop3)}</strong> (<strong>${percentual}%</strong> do valor total da base filtrada):<br><br>`;
                    message.innerHTML += top3.map(([parte, valor]) => {
                        const perc = (valor / valorTotal * 100).toFixed(1);
                        return `<div class="flex items-center gap-2 mb-1 mt-1"><span class="font-bold" style="color: #f59e0b;">‚óè</span> <strong>${parte}:</strong> ${fmtMoney(valor)} <span class="opacity-75">(${perc}%)</span></div>`;
                    }).join('');
                    
                    alert.classList.remove('hidden');
                    return;
                }
            }
            
            document.getElementById('abcAlert').classList.add('hidden');
        }

        function renderAll() {
            const q = (document.getElementById('globalSearch') || {value: ''}).value.toLowerCase();
            const filtered = dStore.filter(d => {
                if(q && !d._searchText.includes(q)) return false;
                for(const dim in filterState) {
                    if(filterState[dim] && filterState[dim].length) {
                        if(dim==='Objeto') { 
                            if(!d._objectsList.some(o=>filterState[dim].includes(o))) return false; 
                        }
                        else if(Array.isArray(d[dim])) {
                            // For optional fields that are arrays (Condena√ß√£o, Acordo, Provis√£o)
                            if(!d[dim].some(val => filterState[dim].includes(val))) return false;
                        }
                        else { 
                            if(!filterState[dim].includes(d[dim])) return false; 
                        }
                    }
                }
                for(const dim in activeChartFilters) {
                    const activeVal = activeChartFilters[dim];
                    if(activeVal) {
                        if(dim==='Objeto') { 
                            if(!d._objectsList.includes(activeVal)) return false; 
                        }
                        else if(Array.isArray(d[dim])) {
                            // For optional fields that are arrays
                            if(!d[dim].includes(activeVal)) return false;
                        }
                        else if(Object.keys(d._allData).includes(dim)) { 
                            if(d._allData[dim] !== activeVal) return false; 
                        } 
                        else { 
                            if(d[dim] !== activeVal) return false; 
                        }
                    }
                }
                return true;
            });

            const sum = filtered.reduce((a,b)=>a+b.Valor,0);
            const prov = filtered.filter(d=>String(d.Risco).toLowerCase().includes('prov')).reduce((a,b)=>a+b.Valor,0);
            document.getElementById('kTotal').innerText = filtered.length;
            document.getElementById('kTotalVal').innerText = fmtMoney(sum);
            document.getElementById('kRiskProv').innerText = fmtMoney(prov);
            document.getElementById('kAvg').innerText = fmtMoney(filtered.length?sum/filtered.length:0);
            document.getElementById('tableCount').innerText = `${filtered.length} processos`;

            analisarCurvaABC(filtered);

            const grid = document.getElementById('chartsGrid'); 
            grid.innerHTML = ''; 
            
            customCharts.forEach(cfg => {
                const hasValidData = filtered.some(d => {
                    if (cfg.x === 'Objeto') return d._objectsList && d._objectsList.length > 0;
                    const val = d[cfg.x] || d._allData[cfg.x];
                    return val && val !== '' && val !== 'N/D' && val !== 'N√£o Informado' && val !== 'null' && val !== null;
                });
                
                if (!hasValidData) return;
                
                const wrap = document.createElement('div');
                wrap.className = "glass p-6 rounded-2xl flex flex-col h-80 card card-chart break-inside-avoid relative group";
                
                let resetBtn = '';
                if(activeChartFilters[cfg.x]) {
                    wrap.classList.add('ring-2', 'ring-brand-500');
                    resetBtn = `<button onclick="clearChartFilter('${cfg.x}')" class="absolute top-4 right-12 text-[9px] bg-brand-500 text-white px-2 py-1 rounded shadow animate-pulse">Limpar Filtro</button>`;
                }

                let note = cfg.x==='Objeto' ? '<p class="text-[9px] mt-2 italic text-center border-t pt-2" style="border-color: var(--layout-border); color: #9CA3AF">* Top Ocorr√™ncias + Agrupamento \"Outros\"</p>' : '';
                
                wrap.innerHTML = `${resetBtn}<div class="flex justify-between items-center mb-4 no-print"><h4 class="font-black text-xs uppercase tracking-wide" style="color: var(--layout-text)">${cfg.title}</h4><button onclick="removeChart('${cfg.id}')" class="text-slate-300 hover:text-rose-500 transition-colors"><i class="fas fa-trash"></i></button></div><div class="flex-1 min-h-0 relative"><canvas id="canv_${cfg.id}"></canvas></div>${note}<div class="resize-handle" style="color: var(--layout-text);"></div>`;
                grid.appendChild(wrap);
                
                const resizeObserver = new ResizeObserver(() => {
                    const chartInstance = Chart.getChart(`canv_${cfg.id}`);
                    if (chartInstance) chartInstance.resize();
                });
                resizeObserver.observe(wrap);

                const agg = {};
                
                if(cfg.x === 'Objeto') {
                    filtered.forEach(d => {
                        d._objectsList.forEach(obj => {
                            if(!agg[obj]) agg[obj] = [];
                            if(cfg.y === 'count') {
                                if(!agg[obj].includes(d.Numero)) agg[obj].push(d.Numero);
                            } else {
                                let rawVal = d._allData[cfg.yCol || mappedValueColumn] || d.Valor;
                                if(typeof rawVal !== 'number') rawVal = parseVal(rawVal);
                                const dividedVal = rawVal / d._objectsList.length;
                                agg[obj].push(dividedVal);
                            }
                        });
                    });
                } else {
                    filtered.forEach(d => {
                        let keys = [];
                        const val = d[cfg.x];
                        
                        // Handle optional fields that are arrays (Condena√ß√£o, Acordo, Provis√£o)
                        if(Array.isArray(val)) {
                            keys = val;
                        } else if(val) {
                            keys = [val];
                        } else if(d._allData[cfg.x]) {
                            keys = [d._allData[cfg.x]];
                        } else {
                            keys = ['N/D'];
                        }

                        keys.forEach(k => {
                            if(!agg[k]) agg[k] = [];
                            if(cfg.y === 'count') {
                                agg[k].push(1);
                            } else {
                                let rawVal = d._allData[cfg.yCol || mappedValueColumn] || d.Valor;
                                if(typeof rawVal !== 'number') rawVal = parseVal(rawVal);
                                agg[k].push(rawVal);
                            }
                        });
                    });
                }

                let sortedData = Object.entries(agg).map(([k,v]) => {
                    let res = 0;
                    if(cfg.y === 'count') {
                        res = cfg.x === 'Objeto' ? v.length : v.reduce((a,b)=>a+b,0);
                    } else if(cfg.y === 'sum') {
                        res = v.reduce((a,b)=>a+b,0);
                    } else {
                        res = v.reduce((a,b)=>a+b,0) / v.length;
                    }
                    return [k, res];
                }).sort((a,b)=>b[1]-a[1]);

                let finalData = sortedData;
                let bgColors = [];
                const limit = cfg.type === 'line' ? 12 : (['bar_h', 'bar'].includes(cfg.type) ? 8 : 9);

                if (sortedData.length > limit) {
                    const topN = sortedData.slice(0, limit);
                    const others = sortedData.slice(limit).reduce((acc, curr) => acc + curr[1], 0);
                    finalData = topN;
                    if (others > 0) finalData.push(['Outros', others]);
                    bgColors = chroma.scale(themeConfig.palette).colors(finalData.length - (others>0?1:0));
                    if(others>0) bgColors.push('#cbd5e1'); 
                } else {
                    bgColors = chroma.scale(themeConfig.palette).colors(Math.max(finalData.length,2));
                }

                const chartConfig = {
                    type: cfg.type.replace('_h',''),
                    data: {
                        labels: finalData.map(d=>d[0]),
                        datasets: [{ 
                            data: finalData.map(d=>d[1]), 
                            backgroundColor: cfg.type === 'line' ? 'rgba(79, 70, 229, 0.1)' : bgColors,
                            borderColor: cfg.type === 'line' ? themeConfig.brand : 'transparent',
                            borderWidth: cfg.type === 'line' ? 3 : 0,
                            fill: cfg.type === 'line',
                            tension: cfg.type === 'line' ? 0.4 : 0,
                            pointRadius: cfg.type === 'line' ? 4 : 0,
                            pointHoverRadius: cfg.type === 'line' ? 6 : 0,
                            pointBackgroundColor: cfg.type === 'line' ? themeConfig.brand : 'transparent',
                            borderRadius: ['bar', 'bar_h'].includes(cfg.type) ? 6 : 0
                        }]
                    },
                    options: { 
                        indexAxis: cfg.type==='bar_h'?'y':'x', 
                        maintainAspectRatio: false, 
                        responsive: true, 
                        plugins: { 
                            legend: { 
                                display: ['doughnut', 'pie', 'polarArea'].includes(cfg.type), 
                                position:'right', 
                                labels: { 
                                    boxWidth: 12, 
                                    font: {size: 11, weight: 600},
                                    padding: 10,
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        if (data.labels.length && data.datasets.length) {
                                            return data.labels.map((label, i) => {
                                                const value = data.datasets[0].data[i];
                                                const formatted = cfg.y === 'count' ? value : formatValue(value, cfg.yCol || mappedValueColumn);
                                                return {
                                                    text: `${label}: ${formatted}`,
                                                    fillStyle: data.datasets[0].backgroundColor[i] || data.datasets[0].backgroundColor,
                                                    hidden: false,
                                                    index: i
                                                };
                                            });
                                        }
                                        return [];
                                    }
                                } 
                            },
                            tooltip: { 
                                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                titleFont: { size: 13, weight: 'bold' },
                                bodyFont: { size: 12 },
                                padding: 12,
                                callbacks: { 
                                    label: (c) => {
                                        if(cfg.y === 'count') return `Quantidade: ${c.raw}`;
                                        return `Valor: ${formatValue(c.raw, cfg.yCol || mappedValueColumn)}`;
                                    }
                                } 
                            }
                        },
                        scales: {}
                    }
                };

                if(!['doughnut', 'pie', 'polarArea', 'radar'].includes(cfg.type)) {
                    chartConfig.options.scales.y = {
                        display: true,
                        beginAtZero: true,
                        ticks: {
                            font: { size: 10, weight: 500 },
                            color: '#9CA3AF',
                            padding: 8,
                            autoSkip: true,
                            maxTicksLimit: cfg.type === 'bar_h' ? 10 : 6,
                            callback: function(val) {
                                if (cfg.type === 'bar_h') {
                                    let label = this.getLabelForValue(val);
                                    return label.length > 25 ? label.substr(0, 25) + '...' : label;
                                }
                                if(cfg.y === 'count') return val;
                                return formatValue(val, cfg.yCol || mappedValueColumn);
                            }
                        },
                        grid: {
                            color: 'rgba(229, 231, 235, 0.5)',
                            drawBorder: false
                        }
                    };
                    
                    chartConfig.options.scales.x = {
                        display: true,
                        ticks: {
                            font: { size: 10, weight: 500 },
                            color: '#9CA3AF',
                            padding: 8,
                            maxRotation: 45,
                            minRotation: 0,
                            autoSkip: true,
                            maxTicksLimit: 10,
                            callback: function(val) {
                                if (cfg.type === 'bar_h') {
                                    if(cfg.y === 'count') return val;
                                    return formatValue(val, cfg.yCol || mappedValueColumn);
                                }
                                let label = this.getLabelForValue(val);
                                return label.length > 15 ? label.substr(0, 15) + '...' : label;
                            }
                        },
                        grid: {
                            display: cfg.type === 'bar_h' || cfg.type === 'line',
                            color: 'rgba(229, 231, 235, 0.3)',
                            drawBorder: false
                        }
                    };
                }

                if(cfg.type === 'radar') {
                    chartConfig.options.scales = {
                        r: {
                            beginAtZero: true,
                            ticks: {
                                font: { size: 10 },
                                backdropColor: 'transparent',
                                callback: function(val) {
                                    if(cfg.y === 'count') return val;
                                    return formatValue(val, cfg.yCol || mappedValueColumn);
                                }
                            },
                            grid: { color: 'rgba(229, 231, 235, 0.5)' },
                            angleLines: { color: 'rgba(229, 231, 235, 0.5)' }
                        }
                    };
                }

                chartConfig.options.onClick = (e, els) => {
                    if(els.length > 0) {
                        const i = els[0].index;
                        const label = finalData[i][0];
                        if(label !== 'Outros') { 
                            activeChartFilters[cfg.x] = label; 
                            renderAll(); 
                        }
                    }
                };

                chartConfig.options.onHover = (e, els) => e.native.target.style.cursor = els.length ? 'pointer' : 'default';

                new Chart(document.getElementById(`canv_${cfg.id}`), chartConfig);
            });

            document.getElementById('dataTable').innerHTML = filtered.slice(0,50).map((d,i) => `<tr class="cursor-pointer border-b last:border-0 transition-colors" style="border-color: var(--layout-border)" onclick="openDetail(${i})">
                    <td class="px-6 py-4 font-bold font-mono text-[11px] whitespace-nowrap" style="color: var(--layout-text)">${d.Numero}</td>
                    <td class="px-6 py-4"><div class="font-bold text-xs" style="color: var(--layout-text)">${d.Cliente}</div><div class="text-slate-400 text-[10px] mt-0.5">vs ${d.Parte}</div></td>
                    <td class="px-6 py-4"><div class="line-clamp-2 text-xs w-48" style="color: var(--layout-text)" title="${d.Objeto}">${d.Objeto}</div></td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded text-[10px] font-medium" style="background: var(--layout-accent); color: var(--layout-text)">${d.Filial}</span></td>
                    <td class="px-6 py-4 text-right font-black text-xs" style="color: var(--layout-text)">${fmtMoney(d.Valor)}</td>
                </tr>`).join('');
            
            window._renderedData = filtered;
        }

        function clearChartFilter(dim) { delete activeChartFilters[dim]; renderAll(); }
        function toggleYCol() { document.getElementById('biYColDiv').classList.toggle('hidden', document.getElementById('biY').value==='count'); }
        
        function addChart() {
            const xVal = document.getElementById('biX').value;
            const yVal = document.getElementById('biY').value;
            const yColVal = yVal === 'count' ? null : (document.getElementById('biYCol').value || mappedValueColumn);
            const typeVal = document.getElementById('biType').value;
            const titleVal = document.getElementById('biTitle').value || `An√°lise de ${xVal}`;
            customCharts.push({ id: 'c'+Date.now(), x: xVal, y: yVal, yCol: yColVal, type: typeVal, title: titleVal }); 
            document.getElementById('biTitle').value = '';
            renderAll(); 
        }
        
        function removeChart(id) { 
            const chart = customCharts.find(c=>c.id===id);
            if(chart) delete activeChartFilters[chart.x];
            customCharts = customCharts.filter(c=>c.id!==id); 
            renderAll(); 
        }
        
        function updatePalette(n) { 
            themeConfig.paletteName = n; 
            themeConfig.palette = PALETTES[n]; 
            themeConfig.brand = PALETTES[n][0]; 
            applyTheme(); 
            renderAll(); 
        }
        
        function updateCustomColor(h) { 
            themeConfig.paletteName='custom'; 
            themeConfig.brand=h; 
            themeConfig.palette=chroma.scale([h,'#cbd5e1']).colors(5); 
            applyTheme(); 
            renderAll(); 
        }
        
        function applyTheme() { 
            document.documentElement.style.setProperty('--brand-500', themeConfig.brand); 
            document.documentElement.style.setProperty('--brand-600', chroma(themeConfig.brand).darken().hex()); 
        }

        function updateLayoutTheme(theme) {
            layoutTheme = theme;
            applyLayoutTheme();
        }

        function applyLayoutTheme() {
            const t = LAYOUT_THEMES[layoutTheme] || LAYOUT_THEMES.minimal;
            document.documentElement.style.setProperty('--layout-bg', t.bg);
            document.documentElement.style.setProperty('--layout-card', t.card);
            document.documentElement.style.setProperty('--layout-text', t.text);
            document.documentElement.style.setProperty('--layout-border', t.border);
            document.documentElement.style.setProperty('--layout-accent', t.accent);
            document.documentElement.style.setProperty('--layout-sidebar', t.sidebar);
            document.documentElement.style.setProperty('--layout-sidebar-text', t.sidebarText);
            document.documentElement.style.setProperty('--layout-sidebar-border', t.sidebarBorder);
            
            const select = document.getElementById('layoutThemeSelect');
            if(select) select.value = layoutTheme;
        }
        
        function openDetail(i) {
            const data = window._renderedData[i];
            const body = document.getElementById('detBody'); body.innerHTML = '';
            document.getElementById('detTitle').innerText = `Detalhes: ${data.Numero}`;
            const core = {'Cliente':data.Cliente, 'Filial':data.Filial, 'Adverso':data.Parte, 'Valor':fmtMoney(data.Valor), 'Risco':data.Risco, '√Årea':data.Area};
            Object.entries(core).forEach(([k,v]) => body.innerHTML += `<div class="border-b border-slate-100 pb-2"><label class="text-[9px] font-black uppercase text-slate-400 block tracking-wider mb-1">${k}</label><span class="font-bold text-slate-800 text-sm">${v}</span></div>`);
            if(data._objectsList.length) body.innerHTML += `<div class="col-span-1 md:col-span-2 bg-slate-50 p-4 rounded-xl border border-slate-100 mt-2"><label class="text-[9px] font-bold text-indigo-500 uppercase block mb-2 tracking-wider">Pedidos Identificados</label><div class="flex flex-wrap gap-2">${data._objectsList.map(o=>`<span class="bg-white border border-slate-200 px-2 py-1 rounded text-xs text-slate-600 font-medium shadow-sm">${o}</span>`).join('')}</div></div>`;
            body.innerHTML += `<div class="col-span-1 md:col-span-2 pt-6"><h4 class="text-xs font-bold text-slate-800 uppercase tracking-widest border-b pb-2 mb-4">Registro Completo (Dados Originais)</h4><div class="grid grid-cols-2 gap-4"></div></div>`;
            const extraContainer = body.lastElementChild.lastElementChild;
            Object.entries(data._allData).forEach(([k,v]) => extraContainer.innerHTML += `<div class="bg-slate-50 p-2 rounded border border-slate-100"><label class="text-[8px] font-bold uppercase text-slate-400 block mb-1 truncate" title="${k}">${k}</label><span class="text-[10px] text-slate-700 font-medium break-words">${v||'(vazio)'}</span></div>`);
            document.getElementById('detailModal').classList.replace('hidden','flex');
        }
        
        function closeDetail() { document.getElementById('detailModal').classList.replace('flex','hidden'); }

    </script>

    </div>
</body>
</html>

